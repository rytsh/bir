---
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";
import Sidebar from "../components/Sidebar.astro";
import ThemeToggle from "../components/ThemeToggle.svelte";

interface Props {
  title: string;
  description?: string;
  keywords?: string;
  currentPath?: string;
}

const { title, description, keywords, currentPath } = Astro.props;
const gaId = import.meta.env.PUBLIC_GA_ID;

const siteName = "Tools";
const defaultDescription =
  "A collection of open-source tools for everyday tasks - encoders, decoders, generators, converters, and more.";
const defaultKeywords =
  "tools, developer tools, web tools, encoder, decoder, generator, converter, base64, url encoding, hash, jwt, barcode, password generator, text tools, hex viewer, data converter, julian date, luhn algorithm";
const metaDescription = description || defaultDescription;
const metaKeywords = keywords || defaultKeywords;
const pageTitle = `${title ? `${title} | ` : ""}${siteName}`;
const canonicalURL = new URL(currentPath || "/", Astro.site);
const ogImage = new URL("/og.jpg", Astro.site);
const twitterImage = new URL("/og.jpg", Astro.site);
---

<!doctype html>
<html lang="en" class="loading">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Modern Favicon Setup -->
    <link rel="icon" href="/favicon.ico" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <meta name="msapplication-TileColor" content="#1a1a1a" />
    <!-- Performance & Theme -->
    <meta name="theme-color" content="#1a1a1a" />
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>

    <!-- Essential Meta Tags -->
    <meta name="description" content={metaDescription} />
    <meta name="keywords" content={metaKeywords} />
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />
    <meta name="author" content="rytsh" />
    <meta name="publisher" content="rytsh" />
    <meta name="copyright" content="Â© 2025 rytsh" />
    <meta name="language" content="English" />
    <meta name="geo.region" content="US" />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Tools - Utilities Collection" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={twitterImage} />
    <meta name="twitter:image:alt" content="Tools - Utilities Collection" />
    {gaId && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}></script>
        <script is:inline define:vars={{ gaId }}>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaId);
        </script>
      </>
    )}
    <!-- Critical: Hide page, set theme and sidebar state before any paint -->
    <style is:inline>
      html.loading { visibility: hidden; }
      /* Disable transitions during initial load */
      html.loading * { transition: none !important; }
    </style>
    <script is:inline>
      (function () {
        // Theme
        const theme = localStorage.getItem("theme");
        const isDark = theme === "dark" || (!theme && window.matchMedia("(prefers-color-scheme: dark)").matches);
        if (isDark) {
          document.documentElement.classList.add("dark");
        }
        
        // Sidebar state for menu icon and collapsed state
        const isLargeScreen = window.innerWidth >= 1024;
        const isCollapsed = localStorage.getItem("sidebar-collapsed") === "true";
        if (isLargeScreen) {
          document.documentElement.dataset.sidebarCollapsed = isCollapsed ? "true" : "false";
        } else {
          document.documentElement.dataset.sidebarCollapsed = "mobile";
        }
      })();
    </script>
    <!-- Client-side navigation -->
    <ClientRouter transition:animate="none" />
    <!-- Apply theme before page swap during client-side navigation -->
    <script is:inline>
      document.addEventListener("astro:before-swap", (event) => {
        // Theme
        const theme = localStorage.getItem("theme");
        const isDark = theme === "dark" || (!theme && window.matchMedia("(prefers-color-scheme: dark)").matches);
        if (isDark) {
          event.newDocument.documentElement.classList.add("dark");
        } else {
          event.newDocument.documentElement.classList.remove("dark");
        }
        // Remove loading class since we're doing client-side navigation
        event.newDocument.documentElement.classList.remove("loading");

        // Sidebar state
        const isLargeScreen = window.innerWidth >= 1024;
        const isCollapsed = localStorage.getItem("sidebar-collapsed") === "true";
        if (isLargeScreen) {
          event.newDocument.documentElement.dataset.sidebarCollapsed = isCollapsed ? "true" : "false";
        } else {
          event.newDocument.documentElement.dataset.sidebarCollapsed = "mobile";
        }
      });
    </script>
  </head>
  <body class="h-full bg-(--color-bg) flex flex-col">
    <!-- Overlay -->
    <div
      id="overlay"
      class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"
      aria-hidden="true"
    >
    </div>

    <div class="flex flex-1 h-full overflow-auto">
      <!-- Sidebar -->
      <div
        id="sidebar"
        class="fixed lg:static inset-y-0 left-0 z-50 transform -translate-x-full lg:translate-x-0 h-full"
        transition:persist
      >
        <Sidebar currentPath={currentPath} />
      </div>
      <!-- Apply sidebar state immediately after sidebar is in DOM -->
      <script is:inline>
        (function() {
          var sb = document.getElementById("sidebar-content");
          if (!sb) return;
          var isLarge = window.innerWidth >= 1024;
          var isCollapsed = localStorage.getItem("sidebar-collapsed") === "true";
          if (isLarge && isCollapsed) {
            sb.classList.add("sidebar-collapsed");
          }
          // Show page now that sidebar state is correct
          document.documentElement.classList.remove("loading");
        })();
      </script>

      <div class="flex flex-col flex-1 min-h-full">
        <!-- Navbar -->
        <header
          class="shrink-0 bg-(--color-sidebar) text-white flex items-center justify-between"
        >
          <button
            id="menu-toggle"
            class="p-2 hover:bg-white/10 transition-colors"
            aria-label="Toggle menu"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <!-- Hamburger icon (mobile) -->
              <path
                class="menu-icon-hamburger"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path>
              <!-- Collapse icon (double chevron left - large screen, not collapsed) -->
              <path
                class="menu-icon-collapse"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 19l-7-7 7-7M19 19l-7-7 7-7"></path>
              <!-- Expand icon (double chevron right - large screen, collapsed) -->
              <path
                class="menu-icon-expand"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
            </svg>
          </button>
          <span class="w-full px-2 text-base tracking-tight">
            <slot name="navbar-title">Collection of Tools</slot>
          </span>
          <div class="flex items-center gap-1">
            <ThemeToggle client:load />
          </div>
        </header>
        <!-- Main Content -->
        <main class="flex-1 p-4 pt-1 w-full mx-auto overflow-auto">
          <slot />
        </main>
      </div>
    </div>

    <script>
      let sidebarScrollTop = 0;

      function updateActiveLink() {
        const currentPath = window.location.pathname;
        const sidebar = document.getElementById("sidebar-content");
        if (!sidebar) return;

        const links = sidebar.querySelectorAll("nav a");
        links.forEach((link) => {
          const href = link.getAttribute("href");
          const isActive =
            href === currentPath ||
            (href && currentPath.startsWith(href + "/"));

          if (isActive) {
            link.classList.remove(
              "text-white/60",
              "hover:text-white",
              "hover:bg-white/5",
            );
            link.classList.add("text-white", "bg-white/10");
          } else {
            link.classList.remove("text-white", "bg-white/10");
            link.classList.add(
              "text-white/60",
              "hover:text-white",
              "hover:bg-white/5",
            );
          }
        });
      }

      function saveSidebarScroll() {
        const nav = document.querySelector("#sidebar-content nav");
        if (nav) {
          sidebarScrollTop = nav.scrollTop;
        }
      }

      function restoreSidebarScroll() {
        const nav = document.querySelector("#sidebar-content nav");
        if (nav) {
          if (sidebarScrollTop === 0) {
            // Scroll to active link if no saved position
            const activeLink = nav.querySelector("a.bg-white\\/10");
            if (activeLink) {
              activeLink.scrollIntoView({ block: "center", behavior: "instant" });
              return;
            }
          }
          nav.scrollTop = sidebarScrollTop;
        }
      }

      function initSidebar() {
        const menuToggle = document.getElementById("menu-toggle");
        const sidebar = document.getElementById("sidebar");
        const sidebarContent = document.getElementById("sidebar-content");
        const overlay = document.getElementById("overlay");

        const isLargeScreen = () => window.innerWidth >= 1024;
        const isCollapsed = () =>
          localStorage.getItem("sidebar-collapsed") === "true";

        const updateSidebarState = () => {
          if (isLargeScreen()) {
            if (isCollapsed()) {
              sidebarContent?.classList.add("sidebar-collapsed");
              document.documentElement.dataset.sidebarCollapsed = "true";
            } else {
              sidebarContent?.classList.remove("sidebar-collapsed");
              document.documentElement.dataset.sidebarCollapsed = "false";
            }
            // Ensure overlay is hidden on large screens
            overlay?.classList.add("hidden");
            document.body.style.overflow = "";
          } else {
            // Mobile behavior
            sidebarContent?.classList.remove("sidebar-collapsed");
            document.documentElement.dataset.sidebarCollapsed = "mobile";
          }
        };

        const toggleMenu = () => {
          if (isLargeScreen()) {
            // Large screen: toggle collapsed state
            const currentlyCollapsed =
              sidebarContent?.classList.contains("sidebar-collapsed");
            const newCollapsed = !currentlyCollapsed;

            if (newCollapsed) {
              sidebarContent?.classList.add("sidebar-collapsed");
              document.documentElement.dataset.sidebarCollapsed = "true";
            } else {
              sidebarContent?.classList.remove("sidebar-collapsed");
              document.documentElement.dataset.sidebarCollapsed = "false";
            }

            localStorage.setItem("sidebar-collapsed", newCollapsed.toString());
          } else {
            // Mobile: toggle slide in/out
            const isOpen = sidebar?.classList.contains("translate-x-0");

            if (isOpen) {
              sidebar?.classList.remove("translate-x-0");
              sidebar?.classList.add("-translate-x-full");
              overlay?.classList.add("hidden");
              document.body.style.overflow = "";
            } else {
              sidebar?.classList.remove("-translate-x-full");
              sidebar?.classList.add("translate-x-0");
              overlay?.classList.remove("hidden");
              document.body.style.overflow = "hidden";
            }
          }
        };

        // Initialize state
        updateSidebarState();
        
        // Add transition class to sidebar for future toggles
        sidebar?.classList.add("transition-transform", "duration-200", "ease-in-out");

        menuToggle?.addEventListener("click", toggleMenu);
        overlay?.addEventListener("click", toggleMenu);

        window.addEventListener("resize", updateSidebarState);
      }

      // Close mobile sidebar before navigation
      function closeMobileSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        const isLargeScreen = window.innerWidth >= 1024;

        if (!isLargeScreen && sidebar?.classList.contains("translate-x-0")) {
          sidebar.classList.remove("translate-x-0");
          sidebar.classList.add("-translate-x-full");
          overlay?.classList.add("hidden");
          document.body.style.overflow = "";
        }
      }

      // Save sidebar scroll position before navigation
      document.addEventListener("astro:before-preparation", () => {
        saveSidebarScroll();
        closeMobileSidebar();
      });

      // Restore sidebar scroll position after navigation
      document.addEventListener("astro:page-load", () => {
        initSidebar();
        updateActiveLink();
        restoreSidebarScroll();
      });
    </script>
  </body>
</html>
