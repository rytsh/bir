---
import "../styles/global.css";
import Sidebar from "../components/Sidebar.astro";
import ThemeToggle from "../components/ThemeToggle.svelte";

interface Props {
  title: string;
  description?: string;
  keywords?: string;
  currentPath?: string;
}

const { title, description, keywords, currentPath } = Astro.props;
const gaId = import.meta.env.PUBLIC_GA_ID;

const siteName = "Tools";
const defaultDescription = "A collection of open-source tools for everyday tasks - encoders, decoders, generators, converters, and more.";
const defaultKeywords = "tools, developer tools, web tools, encoder, decoder, generator, converter, base64, url encoding, hash, jwt, barcode, password generator, text tools, hex viewer, data converter, julian date, luhn algorithm";
const metaDescription = description || defaultDescription;
const metaKeywords = keywords || defaultKeywords;
const pageTitle = `${title ? `${title} | ` : ""}${siteName}`;
const canonicalURL = new URL(currentPath || "/", Astro.site);
const ogImage = new URL("/og.jpg", Astro.site);
const twitterImage = new URL("/og.jpg", Astro.site);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Modern Favicon Setup -->
    <link rel="icon" href="/favicon.ico" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <meta name="msapplication-TileColor" content="#1a1a1a" />
    <!-- Performance & Theme -->
    <meta name="theme-color" content="#1a1a1a" />
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>

    <!-- Essential Meta Tags -->
    <meta name="description" content={metaDescription} />
    <meta name="keywords" content={metaKeywords} />
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
    <meta name="author" content="rytsh" />
    <meta name="publisher" content="rytsh" />
    <meta name="copyright" content="Â© 2025 rytsh" />
    <meta name="language" content="English" />
    <meta name="geo.region" content="US" />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Tools - Utilities Collection" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={twitterImage} />
    <meta name="twitter:image:alt" content="Tools - Utilities Collection" />
    {gaId && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}></script>
        <script is:inline define:vars={{ gaId }}>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaId);
        </script>
      </>
    )}
    <!-- Prevent flash of wrong theme -->
    <script is:inline>
      const theme = localStorage.getItem('theme');
      if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }
    </script>
  </head>
  <body class="h-full bg-(--color-bg) flex flex-col">
    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden" aria-hidden="true"></div>

    <div class="flex flex-1 h-full overflow-auto">
      <!-- Sidebar -->
      <div id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-200 ease-in-out h-full">
        <Sidebar currentPath={currentPath} />
      </div>

      <div class="flex flex-col flex-1 min-h-full">
            <!-- Navbar -->
    <header class="shrink-0 bg-(--color-sidebar) text-white flex items-center justify-between">
              <button
          id="menu-toggle"
          class="p-2 hover:bg-white/10 transition-colors"
          aria-label="Toggle menu"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path id="menu-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
       <span class="w-full px-2 text-base tracking-tight">
         <slot name="navbar-title">Collection of Tools</slot>
       </span>
      <div class="flex items-center gap-1">
        <ThemeToggle client:load />
      </div>
    </header>
    <!-- Main Content -->
    <main class="flex-1 p-4 pt-1 w-full mx-auto overflow-auto">
      <slot />
    </main>
  </div>
    </div>

    <script>
      const menuToggle = document.getElementById('menu-toggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarContent = document.getElementById('sidebar-content');
      const overlay = document.getElementById('overlay');
      const menuIcon = document.getElementById('menu-icon');

      const isLargeScreen = () => window.innerWidth >= 1024;
      const isCollapsed = () => localStorage.getItem('sidebar-collapsed') === 'true';

      const updateSidebarState = () => {
        if (isLargeScreen()) {
          if (isCollapsed()) {
            sidebarContent?.classList.add('sidebar-collapsed');
            updateMenuIcon(true);
          } else {
            sidebarContent?.classList.remove('sidebar-collapsed');
            updateMenuIcon(false);
          }
          // Ensure overlay is hidden on large screens
          overlay?.classList.add('hidden');
          document.body.style.overflow = '';
        } else {
          // Mobile behavior
          sidebarContent?.classList.remove('sidebar-collapsed');
          updateMenuIcon(false);
        }
      };

      const updateMenuIcon = (collapsed:boolean) => {
        if (!menuIcon) return;

        if (!isLargeScreen()) {
          // Show menu icon (hamburger) on mobile
          menuIcon.setAttribute('d', 'M4 6h16M4 12h16M4 18h16');
        } else if (collapsed) {
          // Show expand icon (double chevron right)
          menuIcon.setAttribute('d', 'M13 5l7 7-7 7M5 5l7 7-7 7');
        } else {
          // Show collapse icon (double chevron left)
          menuIcon.setAttribute('d', 'M11 19l-7-7 7-7M19 19l-7-7 7-7');
        }
      };

      const toggleMenu = () => {
        if (isLargeScreen()) {
          // Large screen: toggle collapsed state
          const currentlyCollapsed = sidebarContent?.classList.contains('sidebar-collapsed');
          const newCollapsed = !currentlyCollapsed;

          if (newCollapsed) {
            sidebarContent?.classList.add('sidebar-collapsed');
          } else {
            sidebarContent?.classList.remove('sidebar-collapsed');
          }

          localStorage.setItem('sidebar-collapsed', newCollapsed.toString());
          updateMenuIcon(newCollapsed);
        } else {
          // Mobile: toggle slide in/out
          const isOpen = sidebar?.classList.contains('translate-x-0');

          if (isOpen) {
            sidebar?.classList.remove('translate-x-0');
            sidebar?.classList.add('-translate-x-full');
            overlay?.classList.add('hidden');
            document.body.style.overflow = '';
          } else {
            sidebar?.classList.remove('-translate-x-full');
            sidebar?.classList.add('translate-x-0');
            overlay?.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
          }
        }
      };

      // Initialize state
      updateSidebarState();

      menuToggle?.addEventListener('click', toggleMenu);
      overlay?.addEventListener('click', toggleMenu);

      window.addEventListener('resize', updateSidebarState);
    </script>
  </body>
</html>
